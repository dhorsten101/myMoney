{% extends "base.html" %}

{% block title %}{{ property.name }}{% endblock %}

{% block content %}

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Door: {{ property.name }}</h2>
        <div class="btn-group d-flex gap-2 ">
            <a class="btn btn-outline-secondary" href="{% url 'door_list' %}">Back</a>
            <a class="btn btn-outline-primary" href="{% url 'door_update' property.id %}">Edit</a>
            <a class="btn btn-outline-danger" href="{% url 'invoice_create' %}?door={{ property.id }}">New Invoice</a>
            <a class="btn btn-outline-info" href="{% url 'expense_create' %}?door={{ property.id }}">New Expense</a>
            <a class="btn btn-outline-success" href="{% url 'door_earnings' property.id %}">Forecast</a>
        </div>
    </div>
    {% url 'door_list' as back_url %}

    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <div class="row mb-1">
                <div class="col-md-4"><strong>Capital Value:</strong> {{ property.capital_value }}</div>
                <div class="col-md-4"><strong>Levies:</strong> {{ property.levies }}</div>
                <div class="col-md-4"><strong>Rates & Taxes:</strong> {{ property.rates_taxes }}</div>
                <div class="col-md-4"><strong>Water & Electricity:</strong> {{ property.water_electricity }}</div>
                <div class="col-md-4"><strong>Internet:</strong> {{ property.internet }}</div>
                <div class="col-md-4"><strong>Cost of Money (6%/yr):</strong> {{ property.cost_of_money_monthly }}</div>
                <div class="col-md-4"><strong>Squares:</strong> {{ property.squares }}</div>
                <div class="col-md-4"><strong>Beds:</strong> {{ property.total_beds }}</div>
                <div class="col-md-4"><strong>Toilets:</strong> {{ property.total_toilets }}</div>
                <div class="col-md-4 text-info"><strong>Rental Income:</strong> {{ property.flow_value }}</div>
                <div class="col-md-4 text-danger"><strong>Total Expenses:</strong> {{ property.total_expenses }}</div>
                <div class="col-md-4 fw-bold  text-success"><strong>Profit:</strong> {{ property.income }}</div>
            </div>

            <div class="row align-items-center mb-1">
                {% if property.agent %}
                    <div class="col-md-4">
                        <strong>Rental Agent:</strong> <a href="{% url 'agent_detail' property.agent.id %}">{{ property.agent.name }}</a>
                    </div>
                {% endif %}
                {% if property.estate_agent %}
                    <div class="col-md-4">
                        <strong>Estate Agent:</strong> <a href="{% url 'estate_agent_detail' property.estate_agent.id %}">{{ property.estate_agent.name }}</a>
                    </div>
                {% endif %}
                {% if property.managing_agent %}
                    <div class="col-md-4">
                        <strong>Managing Agent:</strong> <a href="{% url 'managing_agent_detail' property.managing_agent.id %}">{{ property.managing_agent.name }}</a>
                    </div>
                {% endif %}
            </div>
            <p class="mb-0"><strong>Address:</strong> {{ property.address }}</p>
        </div>
    </div>

    {% if month_labels %}
        <div class="card shadow-sm mb-3">
            <div class="card-header">Live-to-date Income vs Expenses</div>
            <div class="card-body">
                <canvas id="propIncomeExpenseChart" height="100"></canvas>
            </div>
        </div>
        {{ month_labels|default:'[]'|json_script:'prop-month-labels' }}
        {{ income_series|default:'[]'|json_script:'prop-income-series' }}
        {{ expense_series|default:'[]'|json_script:'prop-expense-series' }}
        <script>
            (function () {
                const elLabels = document.getElementById('prop-month-labels');
                const elIncome = document.getElementById('prop-income-series');
                const elExpenses = document.getElementById('prop-expense-series');
                if (!elLabels) return;
                const labels = JSON.parse(elLabels.textContent || '[]');
                const income = elIncome ? JSON.parse(elIncome.textContent || '[]') : [];
                const expenses = elExpenses ? JSON.parse(elExpenses.textContent || '[]') : [];

                // Build cumulative series (life-to-date)
                function toCumulative(arr) {
                    let running = 0;
                    return (arr || []).map(v => {
                        const n = Number(v) || 0;
                        running += n;
                        return running;
                    });
                }

                const cumIncome = toCumulative(income);
                const cumExpenses = toCumulative(expenses);
                if (!Array.isArray(labels) || labels.length === 0) return;
                const ctx = document.getElementById('propIncomeExpenseChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Cumulative Income (paid)',
                                data: cumIncome,
                                borderColor: 'rgba(25, 135, 84, 1)',
                                backgroundColor: 'rgba(25, 135, 84, 0.15)',
                                tension: 0.2,
                                fill: true,
                            },
                            {
                                label: 'Cumulative Expenses',
                                data: cumExpenses,
                                borderColor: 'rgba(220, 53, 69, 1)',
                                backgroundColor: 'rgba(220, 53, 69, 0.15)',
                                tension: 0.2,
                                fill: true,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: {mode: 'index', intersect: false},
                        stacked: false,
                        plugins: {
                            legend: {position: 'top'},
                            tooltip: {callbacks: {label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y.toLocaleString()}`}}
                        },
                        scales: {
                            y: {beginAtZero: true}
                        }
                    }
                });
            })();
        </script>
    {% endif %}
    <style>
        .card-header[role="button"] { cursor: pointer; }
        .card-header[role="button"] .toggle-caret { transition: transform .2s ease; }
        .card-header[role="button"][aria-expanded="true"] .toggle-caret { transform: rotate(90deg); }
    </style>
    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center" role="button"
             data-bs-toggle="collapse" data-bs-target="#invoicesCollapse"
             aria-expanded="false" aria-controls="invoicesCollapse" style="cursor: pointer;">
            <span>Linked Invoices</span><i class="bi bi-chevron-right toggle-caret ms-2"></i>
        </div>
        <div id="invoicesCollapse" class="collapse">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>Description</th>
                    <th>Issue Date</th>
                    <th>Status</th>
                    <th class="text-end">Total</th>
                    <th class="text-end">Actions</th>
                </tr>
                </thead>
                <tbody>
                {% for inv in property.invoices.all %}
                    <tr>
                        <td><a href="{% url 'invoice_detail' inv.id %}">{{ inv.number }}</a></td>
                        <td>{{ inv.description }}</td>
                        <td>{{ inv.issue_date }}</td>
                        <td>{{ inv.get_status_display }}</td>
                        <td class="text-end">{{ inv.total }}</td>
                        <td class="text-end">
                            <a class="btn btn-sm btn-outline-secondary" href="{% url 'invoice_update' inv.id %}">Edit</a>
                            <form method="post" action="{% url 'invoice_delete' inv.id %}" class="d-inline" onsubmit="return confirm('Delete invoice {{ inv.number }}?');">
                                {% csrf_token %}
                                <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                            </form>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="7" class="text-center text-muted">No invoices linked.</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        </div>
    </div>

    <div class="card shadow-sm mt-3">
        <div class="card-header d-flex justify-content-between align-items-center" role="button"
             data-bs-toggle="collapse" data-bs-target="#expensesCollapse"
             aria-expanded="false" aria-controls="expensesCollapse" style="cursor: pointer;">
            <span>Linked Expenses</span><i class="bi bi-chevron-right toggle-caret ms-2"></i>
        </div>
        <div id="expensesCollapse" class="collapse">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-light">
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th class="text-end">Amount</th>
                    <th class="text-end">Actions</th>
                </tr>
                </thead>
                <tbody>
                {% for exp in linked_expenses %}
                    <tr>
                        <td>{{ exp.date }}</td>
                        <td>{{ exp.description }}</td>
                        <td class="text-end">{{ exp.amount }}</td>
                        <td class="text-end">
                            <a class="btn btn-sm btn-outline-secondary" href="{% url 'expense_update' exp.id %}">Edit</a>
                            <form method="post" action="{% url 'expense_delete' exp.id %}" class="d-inline" onsubmit="return confirm('Delete this expense dated {{ exp.date }}?');">
                                {% csrf_token %}
                                <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                            </form>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="4" class="text-center text-muted">No expenses linked.</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        </div>
    </div>



    <div class="card shadow-sm mb-3 mt-3">
        <div class="card-header d-flex justify-content-between align-items-center" role="button"
             data-bs-toggle="collapse" data-bs-target="#documentsCollapse"
             aria-expanded="false" aria-controls="documentsCollapse" style="cursor: pointer;">
            <span>Documents</span><i class="bi bi-chevron-right toggle-caret ms-2"></i>
        </div>
        <div id="documentsCollapse" class="collapse">
        <div class="card-body">
            <style>
                /* Show preview when hovering any part of the row */
                table.table tr.previewable { position: relative; }
                .doc-preview-fixed {
                    display: none;
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    width: min(65vw, 900px);
                    max-height: 80vh;
                    object-fit: contain;
                    border: 1px solid #dee2e6;
                    background: #fff;
                    padding: 4px;
                    border-radius: .25rem;
                    box-shadow: 0 .5rem 1rem rgba(0,0,0,.15);
                    z-index: 1060; /* above cards */
                    pointer-events: none;
                }
                table.table tr.previewable:hover .doc-preview-fixed { display: block; }
            </style>
            <form method="post" enctype="multipart/form-data" action="{% url 'door_upload_document' property.id %}" class="mb-3">
                {% csrf_token %}
                <div class="row g-2 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label">Title</label>
                        {{ document_form.title }}
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Category</label>
                        {{ document_form.category }}
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Create As</label>
                        {{ document_form.create_as }}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">File</label>
                        {{ document_form.file }}
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" type="submit">Upload</button>
                    </div>
                </div>
        
            </form>

            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-light">
                    <tr>
                        <th>Title</th>
                        <th>Category</th>
                        <th>Uploaded</th>
                        <th>By</th>
                        <th>File</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for doc in documents %}
                        <tr class="previewable">
                            <td>{{ doc.title }}</td>
                            <td>{{ doc.get_category_display }}</td>
                            <td>{{ doc.uploaded_at }}</td>
                            <td>{% if doc.created_by %}{{ doc.created_by.username }}{% else %}-{% endif %}</td>
                            <td>
                                <a href="{{ doc.file.url }}" target="_blank" rel="noopener">Download</a>
                                {% with url=doc.file.url|lower %}
                                    {% if '.png' in url or '.jpg' in url or '.jpeg' in url or '.gif' in url or '.webp' in url %}
                                        <img src="{{ doc.file.url }}" alt="{{ doc.title }}" class="doc-preview-fixed" loading="lazy">
                                    {% endif %}
                                {% endwith %}
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="5" class="text-center text-muted">No documents uploaded.</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        </div>
    </div>
    <div class="card shadow-sm mb-3">
        <div class="card-header d-flex justify-content-between align-items-center" role="button"
             data-bs-toggle="collapse" data-bs-target="#imagesCollapse"
             aria-expanded="false" aria-controls="imagesCollapse" style="cursor: pointer;">
            <span>Images</span><i class="bi bi-chevron-right toggle-caret ms-2"></i>
        </div>
        <div id="imagesCollapse" class="collapse">
        <div class="card-body">
            <div class="row g-3 mb-3">
                {% for img in property.images.all %}
                    <div class="col-6 col-md-3">
                        <img src="{{ img.image.url }}" alt="{{ property.name }}" class="img-fluid rounded border">
                    </div>
                {% empty %}
                    <div class="text-muted">No images uploaded.</div>
                {% endfor %}
            </div>
            <form method="post" enctype="multipart/form-data" action="{% url 'rental_property_upload_image' property.id %}">
                {% csrf_token %}
                <div class="input-group">
                    {{ image_form.image }}
                    <button class="btn btn-sm btn-primary" type="submit">Upload</button>
                </div>
            </form>
            {% if property.website %}
                <a class="btn btn-sm btn-outline-primary mt-2" href="{% url 'preview_images_from_url' %}?url={{ property.website|urlencode }}" target="_blank" rel="noopener">Preview Images From Website</a>
            {% endif %}
        </div>
        </div>
    </div>
{% endblock %}


