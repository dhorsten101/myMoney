{% extends "base.html" %}

{% block title %}Horsten Homes Dashboard{% endblock %}

{% block content %}

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0">Horsten Homes</h1>
    </div>

    <div class="row g-3 mb-3">
        <h5 class="text-muted mb-1">Totals from Start date 1st March 2025</h5>
        <div class="col-md-2">
            <a href="/property/" class="text-decoration-none d-block">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted mb-1">Properties</h6>
                        <div class="display-6 text-success">{{ total_properties_count }}</div>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-2">
            <a href="/rental/" class="text-decoration-none d-block">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted mb-1">Doors</h6>
                        <div class="display-6 text-success">{{ total_doors_count }}</div>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-md-2">
            <a href="/rental/" class="text-decoration-none d-block">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted mb-1">Squares</h6>
                        <div class="display-6 text-success">{{ total_door_squares }}</div>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-md-2">
            <a href="/tenants/" class="text-decoration-none d-block">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted mb-1">Tenants</h6>
                        <div class="display-6 text-success">{{ total_tenants_count }}</div>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-md-2">
            <a href="/agents/" class="text-decoration-none d-block">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted mb-1">Agents</h6>
                        <div class="display-6 text-success">{{ total_agents_count }}</div>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-2">
            <a href="{% url 'rental_pipeline_list' %}" class="text-decoration-none d-block">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted mb-1">Pipelines</h6>
                        <div class="display-6 text-success">{{ total_pipelines_count }}</div>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-2">
            <a href="/invoice/" class="text-decoration-none d-block">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted mb-1">Invoices</h6>
                        <div class="display-6 text-success">{{ total_invoices_count }}</div>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-2">
            <a href="/expenses/" class="text-decoration-none d-block">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted mb-1">Expenses</h6>
                        <div class="display-6 text-success">{{ total_expenses_count }}</div>
                    </div>
                </div>
            </a>
        </div>

        <h5 class="text-muted mb-1">Accounts</h5>

        <div class="col-md-3">

            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-1">Initial Asset Value</h6>
                    <div class="display-6 text-success">R {{ total_rental_capital|floatformat:2 }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-1">Total Income</h6>
                    <div class="display-6 text-success">R {{ total_rental_income|floatformat:2 }}</div>
                </div>
            </div>
        </div>



        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-1">Total Expenses</h6>
                    <div class="display-6 text-danger">R {{ total_rental_expenses|floatformat:2 }}</div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-1">Profit</h6>
                    <div class="display-6 {% if total_rental_net >= 0 %}text-primary{% else %}text-danger{% endif %}">R {{ total_rental_net|floatformat:2 }}</div>
                </div>
            </div>
        </div>



    </div>

    <!-- <div class="card shadow-sm mb-3">
    <div class="card-body">
        <h5 class="card-title mb-3">Monthly Paid Totals</h5>
        <canvas id="aggEarningsChart" height="60"></canvas>
    </div>
</div>

<div class="card shadow-sm">
    <div class="table-responsive">
        <table class="table table-striped table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>Month</th>
                    <th class="text-end">Total</th>
                </tr>
            </thead>
            <tbody>
            {% for r in rows %}
                <tr>
                    <td>{{ r.month|date:"Y-m" }}</td>
                    <td class="text-end">{{ r.total }}</td>
                </tr>
            {% empty %}
                <tr><td colspan="2" class="text-center text-muted">No paid invoices for this property.</td></tr>
            {% endfor %}
            </tbody>
            <tfoot>
                <tr class="table-light">
                    <th>Grand Total</th>
                    <th class="text-end">{{ grand_total }}</th>
                </tr>
            </tfoot>
        </table>
    </div>
</div> -->

    {# Provide data as JSON for JS to read #}
    {{ agg_labels|default:'[]'|json_script:'agg-labels' }}
    {{ agg_cumulative|default:'[]'|json_script:'agg-cumulative' }}
    {{ agg_capital_line|default:'[]'|json_script:'agg-capital' }}
    {{ agg_initial_capital_line|default:'[]'|json_script:'agg-initial-capital' }}
    {{ agg_coverage_line|default:'[]'|json_script:'agg-coverage' }}
    {# Provide payoff markers as safe JSON for JS to read #}
    {{ payoff_flow_label_all|json_script:'agg-payoff-flow' }}
    {{ payoff_growing_label_all|json_script:'agg-payoff-grow' }}
    {{ months_to_payoff_flow_all|json_script:'agg-payoff-flow-months' }}
    {{ months_to_payoff_growing_all|json_script:'agg-payoff-grow-months' }}
    {# Property markers for map #}
    {{ property_markers|json_script:'property-markers' }}

    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        (function () {
            const elLabelsAgg = document.getElementById('agg-labels');
            const elCumAgg = document.getElementById('agg-cumulative');
            if (!elLabelsAgg || !elCumAgg) return;
            const labelsAgg = JSON.parse(elLabelsAgg.textContent || '[]');
            const cumulativeAgg = JSON.parse(elCumAgg.textContent || '[]');
            const ctxAggEarn = document.getElementById('aggEarningsChart').getContext('2d');
            new Chart(ctxAggEarn, {
                type: 'line',
                data: {
                    labels: labelsAgg,
                    datasets: [{label: 'Paid Total', data: cumulativeAgg, borderColor: 'rgba(13, 110, 253, 1)', backgroundColor: 'rgba(13, 110, 253, 0.2)', tension: 0.2, fill: true}]
                }
            });
        })();
    </script>

    <script>
        (function () {
            const elLabelsAgg = document.getElementById('agg-labels');
            const elCumAgg = document.getElementById('agg-cumulative');
            const elCapital = document.getElementById('agg-capital');
            const elInitial = document.getElementById('agg-initial-capital');
            const elCoverage = document.getElementById('agg-coverage');
            if (!elLabelsAgg) return;
            const labelsAgg = JSON.parse(elLabelsAgg.textContent || '[]');
            const cumulativeAgg = elCumAgg ? JSON.parse(elCumAgg.textContent || '[]') : [];
            const capitalLineAgg = elCapital ? JSON.parse(elCapital.textContent || '[]') : [];
            const initialCapitalAgg = elInitial ? JSON.parse(elInitial.textContent || '[]') : [];
            const coverageAgg = elCoverage ? JSON.parse(elCoverage.textContent || '[]') : [];
            const elPayoffFlow = document.getElementById('agg-payoff-flow');
            const elPayoffGrow = document.getElementById('agg-payoff-grow');
            const elPayoffFlowMonths = document.getElementById('agg-payoff-flow-months');
            const elPayoffGrowMonths = document.getElementById('agg-payoff-grow-months');
            const payoffFlow = elPayoffFlow ? JSON.parse(elPayoffFlow.textContent) : null;
            const payoffGrow = elPayoffGrow ? JSON.parse(elPayoffGrow.textContent) : null;
            const payoffFlowMonths = elPayoffFlowMonths ? JSON.parse(elPayoffFlowMonths.textContent) : null;
            const payoffGrowMonths = elPayoffGrowMonths ? JSON.parse(elPayoffGrowMonths.textContent) : null;
            if (!labelsAgg.length) return;

            const ctxAggProj = document.getElementById('aggProjectionChart').getContext('2d');
            new Chart(ctxAggProj, {
                type: 'line',
                data: {
                    labels: labelsAgg,
                    datasets: [
                        {label: 'Cumulative Flow (All)', data: cumulativeAgg, borderColor: 'rgba(25,135,84,1)', backgroundColor: 'rgba(25,135,84,0.2)', tension: 0.2, fill: true},
                        {label: 'Capital (All)', data: capitalLineAgg, borderColor: 'rgba(220,53,69,1)', backgroundColor: 'rgba(220,53,69,0.2)', tension: 0, fill: false},
                        {label: 'Initial Capital (All)', data: initialCapitalAgg, borderColor: 'rgba(108,117,125,1)', backgroundColor: 'rgba(108,117,125,0.2)', borderDash: [6, 6], tension: 0, fill: false},
                        {label: 'Flow + Appreciation (Coverage, All)', data: coverageAgg, borderColor: 'rgba(255,159,64,1)', backgroundColor: 'rgba(255,159,64,0.2)', tension: 0.2, fill: false},
                    ]
                },
                options: {
                    responsive: true,
                    scales: {y: {beginAtZero: true}},
                    plugins: {
                        annotation: {
                            annotations: (function () {
                                const ann = {};
                                if (payoffFlow) {
                                    const flowContent = payoffFlowMonths ? `Payoff (Flow All): ${payoffFlow} (${payoffFlowMonths} months)` : `Payoff (Flow All): ${payoffFlow}`;
                                    ann.payoffFlowAll = {type: 'line', scaleID: 'x', value: payoffFlow, borderColor: 'rgba(13,110,253,0.8)', borderDash: [4, 4], borderWidth: 2, label: {display: true, content: flowContent, backgroundColor: 'rgba(255,255,255,0.8)', padding: 4, position: 'center'}};
                                }
                                if (payoffGrow) {
                                    const growContent = payoffGrowMonths ? `Payoff (Flow+App All): ${payoffGrow} (${payoffGrowMonths} months)` : `Payoff (Flow+App All): ${payoffGrow}`;
                                    ann.payoffGrowAll = {type: 'line', scaleID: 'x', value: payoffGrow, borderColor: 'rgba(33,37,41,0.7)', borderDash: [6, 4], borderWidth: 2, label: {display: true, content: growContent, backgroundColor: 'rgba(255,255,255,0.8)', padding: 4, position: 'start'}};
                                }
                                return ann;
                            })()
                        }
                    }
                }
            });
        })();
    </script>

    <div class="card shadow-sm mt-3">
        <div class="card-body">
            <h5 class="card-title mb-3">Properties Map</h5>
            <div id="propertiesMap" style="height: 420px; border-radius: .5rem; overflow: hidden;"></div>
        </div>
    </div>

    <script>
        (function () {
            const el = document.getElementById('property-markers');
            if (!el) return;
            const markers = JSON.parse(el.textContent || '[]');
            if (!markers.length) return;

            const map = L.map('propertiesMap');
            const coords = markers.map(m => [m.lat, m.lng]);
            const bounds = L.latLngBounds(coords);
            map.fitBounds(bounds.pad(0.1));

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            markers.forEach(m => {
                const popup = `<div><strong>${m.name}</strong><br>${m.address || ''}<br><a href="${m.url}">View</a></div>`;
                L.marker([m.lat, m.lng]).addTo(map).bindPopup(popup);
            });
        })();
    </script>
{% endblock %}


