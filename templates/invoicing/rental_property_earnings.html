{% extends "base.html" %}

{% block title %}{{ property.name }} Earnings{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>{{ property.name }} â€“ Earnings</h2>
    <div>
        <a class="btn btn-outline-secondary" href="{% url 'rental_property_detail' property.id %}">Back</a>
        <a class="btn btn-outline-secondary" href="{% url 'homes_dashboard' %}">Go to Dash</a>
    </div>
</div>



{% if months_to_payoff %}
<div class="card shadow-sm mb-3">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center"> 
            <h5 class="card-title mb-0">Projection to Payoff's</h5>
            <div class="d-flex align-items-center">
                <form method="get" class="d-flex align-items-center">
                    <label for="rateSelect" class="me-2 mb-0 small">Growth</label>
                    <select id="rateSelect" name="rate" class="form-select form-select-sm" onchange="this.form.submit()">
                        <option value="3" {% if growth_rate_percent|floatformat:'2' == '3.00' %}selected{% endif %}>3%</option>
                        <option value="4" {% if growth_rate_percent|floatformat:'2' == '4.00' %}selected{% endif %}>4%</option>
                        <option value="5" {% if growth_rate_percent|floatformat:'2' == '5.00' %}selected{% endif %}>5%</option>
                        <option value="6" {% if growth_rate_percent|floatformat:'2' == '6.00' %}selected{% endif %}>6%</option>
                        <option value="7.5" {% if growth_rate_percent|floatformat:'2' == '7.50' %}selected{% endif %}>7.5%</option>
                        <option value="10" {% if growth_rate_percent|floatformat:'2' == '10.00' %}selected{% endif %}>10%</option>
                        <option value="12.5" {% if growth_rate_percent|floatformat:'2' == '12.50' %}selected{% endif %}>12.5%</option>
                        <option value="15" {% if growth_rate_percent|floatformat:'2' == '15.00' %}selected{% endif %}>15%</option>
                        <option value="17.5" {% if growth_rate_percent|floatformat:'2' == '17.50' %}selected{% endif %}>17.5%</option>
                        <option value="20" {% if growth_rate_percent|floatformat:'2' == '20.00' %}selected{% endif %}>20%</option>
                        <option value="22.5" {% if growth_rate_percent|floatformat:'2' == '22.50' %}selected{% endif %}>22.5%</option>
                        <option value="25" {% if growth_rate_percent|floatformat:'2' == '25.00' %}selected{% endif %}>25%</option>
                        <option value="27.5" {% if growth_rate_percent|floatformat:'2' == '27.50' %}selected{% endif %}>27.5%</option>
                        <option value="30" {% if growth_rate_percent|floatformat:'2' == '30.00' %}selected{% endif %}>30%</option>
                        <option value="32.5" {% if growth_rate_percent|floatformat:'2' == '32.50' %}selected{% endif %}>32.5%</option>
                        <option value="35" {% if growth_rate_percent|floatformat:'2' == '35.00' %}selected{% endif %}>35%</option>
                        <option value="37.5" {% if growth_rate_percent|floatformat:'2' == '37.50' %}selected{% endif %}>37.5%</option>
                        <option value="40" {% if growth_rate_percent|floatformat:'2' == '40.00' %}selected{% endif %}>40%</option>
                        <option value="42.5" {% if growth_rate_percent|floatformat:'2' == '42.50' %}selected{% endif %}>42.5%</option>
                        <option value="45" {% if growth_rate_percent|floatformat:'2' == '45.00' %}selected{% endif %}>45%</option>
                        <option value="47.5" {% if growth_rate_percent|floatformat:'2' == '47.50' %}selected{% endif %}>47.5%</option>
                        <option value="50" {% if growth_rate_percent|floatformat:'2' == '50.00' %}selected{% endif %}>50%</option>
                    </select>
                </form>
            </div>
            <!-- <div>
                <span class="me-3"><strong>Capital:</strong> {{ capital }}</span>
                <span class="me-3"><strong>Monthly Flow:</strong> {{ monthly_flow }}</span>
                <span class="me-3"><strong>Growth:</strong> {{ growth_rate_percent|default:5 }}%</span>
                <span class="me-3"><strong>Months:</strong> {{ months_to_payoff }}</span>
                <span class="me-3"><strong>Payoff Date (Flow + Appreciation):</strong> {{ projected_payoff_date }}</span>
                {% if months_to_payoff_flow %}
                    <span class="me-3"><strong>Months (Flow Only):</strong> {{ months_to_payoff_flow }}</span>
                    <span class="me-3"><strong>Payoff Date (Flow Only):</strong> {{ projected_payoff_date_flow }}</span>
                {% endif %}
                {% if payoff_years is not None %}
                    <span><strong>Time to Payoff:</strong> {{ payoff_years }}y {{ payoff_months }}m</span>
                {% endif %}
            </div> -->
        </div>
        <canvas id="projectionChart" height="180" class="mt-3"></canvas>
    </div>
</div>
<div class="card shadow-sm mb-3">
    <div class="card-body">
        <h5 class="card-title mb-3">Monthly Paid Totals</h5>
        <canvas id="earningsChart" height="60"></canvas>
    </div>
</div>
{% endif %}

<div class="card shadow-sm">
    <div class="table-responsive">
        <table class="table table-striped table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>Month</th>
                    <th class="text-end">Total</th>
                </tr>
            </thead>
            <tbody>
            {% for r in rows %}
                <tr>
                    <td>{{ r.month|date:"Y-m" }}</td>
                    <td class="text-end">{{ r.total }}</td>
                </tr>
            {% empty %}
                <tr><td colspan="2" class="text-center text-muted">No paid invoices for this property.</td></tr>
            {% endfor %}
            </tbody>
            <tfoot>
                <tr class="table-light">
                    <th>Grand Total</th>
                    <th class="text-end">{{ grand_total }}</th>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

{# Embed data safely as JSON outside JS block #}
{{ labels|json_script:'hist-labels' }}
{{ values|json_script:'hist-values' }}
{{ proj_labels|json_script:'proj-labels' }}
{{ proj_values|json_script:'proj-values' }}
{{ proj_capital_line|json_script:'proj-capital-line' }}
{{ proj_initial_capital_line|json_script:'proj-initial-capital-line' }}
{{ proj_remaining_growing_capital_line|json_script:'proj-remaining-growing' }}
{{ projected_payoff_date|json_script:'proj-payoff-label' }}
{{ months_to_payoff|json_script:'proj-payoff-months' }}
{{ payoff_flow_label|json_script:'proj-payoff-flow' }}
{{ months_to_payoff_flow|json_script:'proj-payoff-flow-months' }}
{{ payoff_flow_label|json_script:'proj-payoff-flow' }}

<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3"></script>
<script>
    (function(){
        const histLabels = JSON.parse(document.getElementById('hist-labels').textContent || '[]');
        const histValues = JSON.parse(document.getElementById('hist-values').textContent || '[]');
        if (histLabels.length) {
            const ctx = document.getElementById('earningsChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: histLabels,
                    datasets: [{
                        label: 'Paid Total',
                        data: histValues,
                        borderColor: 'rgba(13, 110, 253, 1)',
                        backgroundColor: 'rgba(13, 110, 253, 0.2)',
                        tension: 0.2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        (function(){
            const plabels = JSON.parse(document.getElementById('proj-labels').textContent || '[]');
            const pvalues = JSON.parse(document.getElementById('proj-values').textContent || '[]');
            const capitalLine = JSON.parse(document.getElementById('proj-capital-line').textContent || '[]');
            const initialCapitalLine = JSON.parse(document.getElementById('proj-initial-capital-line').textContent || '[]');
            const remainingGrowingLine = JSON.parse(document.getElementById('proj-remaining-growing').textContent || '[]');
            const pctx = document.getElementById('projectionChart').getContext('2d');
            if (!plabels.length) { return; }
            const payoffLabel = JSON.parse(document.getElementById('proj-payoff-label').textContent || 'null');
            const payoffFlowLabel = JSON.parse(document.getElementById('proj-payoff-flow').textContent || 'null');
            const payoffMonths = JSON.parse(document.getElementById('proj-payoff-months').textContent || 'null');
            const payoffFlowMonths = JSON.parse(document.getElementById('proj-payoff-flow-months').textContent || 'null');
            new Chart(pctx, {
                type: 'line',
                data: {
                    labels: plabels,
                    datasets: [
                        {
                            label: 'Cumulative Flow',
                            data: pvalues,
                            borderColor: 'rgba(25, 135, 84, 1)',
                            backgroundColor: 'rgba(25, 135, 84, 0.2)',
                            tension: 0.2,
                            fill: true
                        },
                        {
                            label: 'Capital',
                            data: capitalLine,
                            borderColor: 'rgba(220, 53, 69, 1)',
                            backgroundColor: 'rgba(220, 53, 69, 0.2)',
                            tension: 0,
                            fill: false
                        },
                        {
                            label: 'Initial Capital',
                            data: initialCapitalLine,
                            borderColor: 'rgba(108, 117, 125, 1)',
                            backgroundColor: 'rgba(108, 117, 125, 0.2)',
                            borderDash: [6, 6],
                            tension: 0,
                            fill: false
                        },
                        {
                            label: 'Flow + Appreciation (Coverage)',
                            data: remainingGrowingLine,
                            borderColor: 'rgba(255, 159, 64, 1)',
                            backgroundColor: 'rgba(255, 159, 64, 0.2)',
                            tension: 0.2,
                            fill: false
                        }
                    ]
                },
                options: (function(){
                    const opts = {
                        responsive: true,
                        scales: { y: { beginAtZero: true } }
                    };
                    if (payoffLabel || payoffFlowLabel) {
                        opts.plugins = opts.plugins || {};
                        opts.plugins.annotation = {
                            annotations: {
                                
                            }
                        };
                        if (payoffLabel) {
                            const payoffContent = payoffMonths ? `Payoff (Flow + Appreciation): ${payoffLabel} (${payoffMonths} months)` : `Payoff (Flow + Appreciation): ${payoffLabel}`;
                            opts.plugins.annotation.annotations.payoff = {
                                type: 'line',
                                scaleID: 'x',
                                value: payoffLabel,
                                borderColor: 'rgba(33, 37, 41, 0.7)',
                                borderDash: [6, 4],
                                borderWidth: 2,
                                label: {
                                    display: true,
                                    content: payoffContent,
                                    position: 'start',
                                    color: '#212529',
                                    backgroundColor: 'rgba(255,255,255,0.8)',
                                    padding: 4
                                }
                            };
                        }
                        if (payoffFlowLabel) {
                            const payoffFlowContent = payoffFlowMonths ? `Payoff (Flow Only): ${payoffFlowLabel} (${payoffFlowMonths} months)` : `Payoff (Flow Only): ${payoffFlowLabel}`;
                            opts.plugins.annotation.annotations.payoffFlow = {
                                type: 'line',
                                scaleID: 'x',
                                value: payoffFlowLabel,
                                borderColor: 'rgba(13, 110, 253, 0.8)',
                                borderDash: [4, 4],
                                borderWidth: 2,
                                label: {
                                    display: true,
                                    content: payoffFlowContent,
                                    position: 'center',
                                    color: '#212529',
                                    backgroundColor: 'rgba(255,255,255,0.8)',
                                    padding: 4
                                }
                            };
                        }
                    }
                    return opts;
                })()
            });
        })();
    })();
</script>
{% endblock %}


