{% extends "base.html" %}

{% block title %}{{ property.name }} Earnings{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>{{ property.name }} – Earnings</h2>
        <div class="btn-group d-flex gap-2 ">
            <a class="btn btn-outline-success" href="{% url 'rental_property_detail' property.id %}">Back</a>
            <a class="btn btn-outline-secondary" href="{% url 'homes_dashboard' %}">Go to Dash</a>
        </div>
    </div>





    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Chart Excluding Asset</h5>
                <form method="get" class="d-flex align-items-center">
                    <input type="hidden" name="rate" value="{{ growth_rate_percent }}"/>
                    <label for="horizonSelectBasic" class="ms-3 me-2 mb-0 small">Horizon</label>
                    <select id="horizonSelectBasic" name="horizon" class="form-select form-select-sm" onchange="this.form.submit()">
                        <option value="1" {% if horizon_years == 1 %}selected{% endif %}>1 year</option>
                        <option value="2.5" {% if horizon_years == 2.5 %}selected{% endif %}>2.5 years</option>
                        <option value="5" {% if horizon_years == 5 %}selected{% endif %}>5 years</option>
                        <option value="10" {% if horizon_years == 10 %}selected{% endif %}>10 years</option>
                        <option value="15" {% if horizon_years == 15 %}selected{% endif %}>15 years</option>
                        <option value="20" {% if horizon_years == 20 %}selected{% endif %}>20 years</option>
                        <option value="25" {% if horizon_years == 25 %}selected{% endif %}>25 years</option>
                        <option value="30" {% if horizon_years == 30 %}selected{% endif %}>30 years</option>
                    </select>
                </form>
            </div>
            <canvas id="basicChart" height="100" class="mt-3"></canvas>
        </div>
    </div>

    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Chart Including Asset</h5>
                <form method="get" class="d-flex align-items-center">
                    <input type="hidden" name="rate" value="{{ growth_rate_percent }}"/>
                    <label for="appSelectBusiness" class="ms-3 me-2 mb-0 small">Appreciation</label>
                    <select id="appSelectBusiness" name="app" class="form-select form-select-sm me-2" onchange="this.form.submit()">
                        <option value="3" {% if appreciation_rate_percent|floatformat:'2' == '3.00' %}selected{% endif %}>3%</option>
                        <option value="4" {% if appreciation_rate_percent|floatformat:'2' == '4.00' %}selected{% endif %}>4%</option>
                        <option value="5" {% if appreciation_rate_percent|floatformat:'2' == '5.00' %}selected{% endif %}>5%</option>
                        <option value="6" {% if appreciation_rate_percent|floatformat:'2' == '6.00' %}selected{% endif %}>6%</option>
                        <option value="7.5" {% if appreciation_rate_percent|floatformat:'2' == '7.50' %}selected{% endif %}>7.5%</option>
                        <option value="10" {% if appreciation_rate_percent|floatformat:'2' == '10.00' %}selected{% endif %}>10%</option>
                        <option value="15" {% if appreciation_rate_percent|floatformat:'2' == '15.00' %}selected{% endif %}>15%</option>
                        <option value="20" {% if appreciation_rate_percent|floatformat:'2' == '20.00' %}selected{% endif %}>20%</option>
                        <option value="25" {% if appreciation_rate_percent|floatformat:'2' == '25.00' %}selected{% endif %}>25%</option>
                        <option value="50" {% if appreciation_rate_percent|floatformat:'2' == '50.00' %}selected{% endif %}>50%</option>
                    </select>
                    <label for="horizonSelectBusiness" class="ms-3 me-2 mb-0 small">Horizon</label>
                    <select id="horizonSelectBusiness" name="horizon" class="form-select form-select-sm" onchange="this.form.submit()">
                        <option value="1" {% if horizon_years == 1 %}selected{% endif %}>1 year</option>
                        <option value="2.5" {% if horizon_years == 2.5 %}selected{% endif %}>2.5 years</option>
                        <option value="5" {% if horizon_years == 5 %}selected{% endif %}>5 years</option>
                        <option value="10" {% if horizon_years == 10 %}selected{% endif %}>10 years</option>
                        <option value="15" {% if horizon_years == 15 %}selected{% endif %}>15 years</option>
                        <option value="20" {% if horizon_years == 20 %}selected{% endif %}>20 years</option>
                        <option value="25" {% if horizon_years == 25 %}selected{% endif %}>25 years</option>
                        <option value="30" {% if horizon_years == 30 %}selected{% endif %}>30 years</option>
                    </select>
                </form>
            </div>
            <canvas id="businessModelChart" height="100" class="mt-3"></canvas>
        </div>

    </div>



    {# Embed data safely as JSON outside JS block #}
    {{ labels|json_script:'hist-labels' }}
    {{ values|json_script:'hist-values' }}
    {{ proj_labels|json_script:'proj-labels' }}
    {{ proj_values|json_script:'proj-values' }}
    {{ proj_capital_line|json_script:'proj-capital-line' }}
    {{ proj_initial_capital_line|json_script:'proj-initial-capital-line' }}
    {{ proj_remaining_growing_capital_line|json_script:'proj-remaining-growing' }}
    {{ proj_monthly_flow_step_line|json_script:'proj-monthly-flow-step' }}
    {{ proj_monthly_flow_step_line_raw|json_script:'proj-monthly-flow-step-raw' }}
    {{ appreciation_monthly|json_script:'prop-appreciation-monthly' }}
    {{ total_income_monthly|json_script:'prop-total-income-monthly' }}
    {{ appreciation_rate_percent|json_script:'app-rate' }}
    {{ projected_payoff_date|json_script:'proj-payoff-label' }}
    {{ months_to_payoff|json_script:'proj-payoff-months' }}
    {{ payoff_flow_label|json_script:'proj-payoff-flow' }}
    {{ months_to_payoff_flow|json_script:'proj-payoff-flow-months' }}
    {{ payoff_flow_label|json_script:'proj-payoff-flow' }}
    {{ capital|json_script:'prop-initial-capital' }}
    {{ monthly_flow|json_script:'prop-monthly-flow' }}
    {{ monthly_expenses|json_script:'prop-monthly-expenses' }}

    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3"></script>
    <script>


        // Basic Chart: cumulative FLOW (5% yearly step), cumulative EXPENSES (5% yearly step), cumulative INCOME
        (function () {
            const labels = JSON.parse(document.getElementById('proj-labels').textContent || '[]');
            const flowRawStep = JSON.parse(document.getElementById('proj-monthly-flow-step-raw').textContent || '[]');
            const baseExpenses = Number(JSON.parse(document.getElementById('prop-monthly-expenses').textContent || '0'));
            const incomeStep = JSON.parse(document.getElementById('proj-monthly-flow-step').textContent || '[]');
            if (!labels.length) {
                return;
            }
            // Build expenses stepwise series (5% yearly increase)
            const expensesStep = [];
            for (let i = 0; i < labels.length; i++) {
                const years = Math.floor(i / 12);
                const factor = Math.pow(1 + 0.05, years);
                expensesStep.push(baseExpenses * factor);
            }
            const cumFlow = [];
            let f = 0;
            const cumExp = [];
            let e = 0;
            const cumInc = [];
            let inc = 0;
            const incomeMonthlyRate = 0.06 / 12; // 6% per year compounded monthly
            for (let i = 0; i < labels.length; i++) {
                // zero-start
                cumFlow.push(f);
                cumExp.push(e);
                cumInc.push(inc);
                f += Number(flowRawStep[i] || 0);
                e += Number(expensesStep[i] || 0);
                inc = inc * (1 + incomeMonthlyRate) + Number(incomeStep[i] || 0);
            }
            const ctx = document.getElementById('basicChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {label: 'Rental Income', data: cumFlow, borderColor: 'rgba(13,110,253,1)', backgroundColor: 'rgba(13,110,253,0.15)', tension: 0.2, fill: false},
                        {label: 'Expenses', data: cumExp, borderColor: 'rgba(220,53,69,0.9)', backgroundColor: 'rgba(220,53,69,0.15)', tension: 0.2, fill: false},
                        {label: 'Income', data: cumInc, borderColor: 'rgba(25,135,84,1)', backgroundColor: 'rgba(25,135,84,0.15)', tension: 0.2, fill: true}
                    ]
                },
                options: {responsive: true, scales: {y: {beginAtZero: true}}}
            });
        })();


        // Business Model chart: Cumulative Flow (5% yearly step), Expenses (5% yearly step), Income with 6% bank growth (zero-start)
        (function () {
            const labels = JSON.parse(document.getElementById('proj-labels').textContent || '[]');
            const flowStep = JSON.parse(document.getElementById('proj-monthly-flow-step-raw').textContent || '[]');
            if (!labels.length || !flowStep.length) {
                return;
            }
            // Zero-start cumulative series
            const cumulativeFlow = [];
            let acc = 0;
            for (let i = 0; i < flowStep.length; i++) {
                cumulativeFlow.push(acc);
                acc += Number(flowStep[i] || 0);
            }
            // Build expenses stepwise (5% yearly)
            const baseExpenses = Number(JSON.parse(document.getElementById('prop-monthly-expenses').textContent || '0'));
            const expensesStep = [];
            for (let i = 0; i < labels.length; i++) {
                const years = Math.floor(i / 12);
                const factor = Math.pow(1 + 0.05, years);
                expensesStep.push(baseExpenses * factor);
            }
            // Zero-start cumulative income with 6% annual compounded monthly (bank growth)
            const incomeStep = JSON.parse(document.getElementById('proj-monthly-flow-step').textContent || '[]');
            const cumulativeIncome = [];
            let accInc = 0;
            const incomeMonthlyRate = 0.06 / 12;
            for (let i = 0; i < incomeStep.length; i++) {
                cumulativeIncome.push(accInc);
                accInc = accInc * (1 + incomeMonthlyRate) + Number(incomeStep[i] || 0);
            }
            // Zero-start cumulative expenses
            const cumulativeExpenses = [];
            let accExp = 0;
            for (let i = 0; i < labels.length; i++) {
                cumulativeExpenses.push(accExp);
                accExp += Number(expensesStep[i] || 0);
            }
            // Cost of money: 6%/yr on initial capital, cumulative (zero-start)
            const initialCapitalBM = JSON.parse(document.getElementById('prop-initial-capital').textContent || '0');
            const monthlyCostBM = initialCapitalBM * (0.06 / 12);
            const costOfMoneyCumulativeBM = [];
            for (let i = 0; i < labels.length; i++) {
                costOfMoneyCumulativeBM.push(monthlyCostBM * i);
            }
            // Static capital value line
            const capitalFlatBM = [];
            for (let i = 0; i < labels.length; i++) {
                capitalFlatBM.push(initialCapitalBM);
            }
            const ctx = document.getElementById('businessModelChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Rental Income',
                            data: cumulativeFlow,
                            borderColor: 'rgba(13, 110, 253, 1)',
                            backgroundColor: 'rgba(13, 110, 253, 0.15)',
                            tension: 0.2,
                            fill: false
                        },
                        {
                            label: 'Expenses',
                            data: cumulativeExpenses,
                            borderColor: 'rgba(220, 53, 69, 0.9)',
                            backgroundColor: 'rgba(220, 53, 69, 0.15)',
                            tension: 0.2,
                            fill: false
                        },
                        {
                            label: 'Capital Value',
                            data: capitalFlatBM,
                            borderColor: 'rgba(108, 117, 125, 1)',
                            backgroundColor: 'rgba(108, 117, 125, 0.15)',
                            borderDash: [6, 6],
                            tension: 0,
                            fill: false
                        },
                        {
                            label: 'Cost of money',
                            data: costOfMoneyCumulativeBM,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.15)',
                            tension: 0.2,
                            fill: false
                        },

                        {
                            label: 'Appreciation',
                            data: (function () {
                                const initialCapital = Number(JSON.parse(document.getElementById('prop-initial-capital').textContent || '0'));
                                const appRate = Number(JSON.parse(document.getElementById('app-rate').textContent || '5')) / 100;
                                const capMonthlyRate = Math.pow(1 + appRate, 1 / 12) - 1; // compounded monthly
                                const arr = [];
                                for (let i = 0; i < labels.length; i++) {
                                    const months = i;
                                    const capValue = initialCapital * Math.pow(1 + capMonthlyRate, months);
                                    const appreciationOnly = capValue - initialCapital; // interest-only (zero-start)
                                    arr.push(appreciationOnly);
                                }
                                return arr;
                            })(),
                            borderColor: 'rgba(111, 66, 193, 1)',
                            backgroundColor: 'rgba(111, 66, 193, 0.15)',
                            tension: 0.2,
                            fill: false
                        },
                        {
                            label: 'Income',
                            data: cumulativeIncome,
                            borderColor: 'rgba(255, 193, 7, 1)',
                            backgroundColor: 'rgba(255, 193, 7, 0.15)',
                            tension: 0.2,
                            fill: false
                        },
                        {
                            label: 'Total Income (income + appreciation − cost of money)',
                            data: (function () {
                                const inc = cumulativeIncome;
                                const initialCapital = Number(JSON.parse(document.getElementById('prop-initial-capital').textContent || '0'));
                                const appRate = Number(JSON.parse(document.getElementById('app-rate').textContent || '5')) / 100;
                                const capMonthlyRate = Math.pow(1 + appRate, 1 / 12) - 1;
                                const appreciationCum = [];
                                for (let i = 0; i < labels.length; i++) {
                                    const months = i;
                                    const capValue = initialCapital * Math.pow(1 + capMonthlyRate, months);
                                    appreciationCum.push(capValue - initialCapital);
                                }
                                const costArray = (function () {
                                    const initialCapitalBM = JSON.parse(document.getElementById('prop-initial-capital').textContent || '0');
                                    const monthlyCostBM = initialCapitalBM * (0.06 / 12);
                                    const arr = [];
                                    for (let i = 0; i < labels.length; i++) {
                                        arr.push(monthlyCostBM * i);
                                    }
                                    return arr;
                                })();
                                const total = [];
                                for (let i = 0; i < labels.length; i++) {
                                    total.push((inc[i] || 0) + (appreciationCum[i] || 0) - (costArray[i] || 0));
                                }
                                return total;
                            })(),
                            borderColor: 'rgba(25, 135, 84, 1)',
                            backgroundColor: 'rgba(25, 135, 84, 0.15)',

                            tension: 0.2,
                            fill: true
                        },

                    ]
                },
                options: (function () {
                    const opts = {responsive: true, scales: {y: {beginAtZero: true}}};
                    // Find first label where total income >= capital
                    const total = (function () {
                        const inc = cumulativeIncome;
                        const initialCapital = Number(JSON.parse(document.getElementById('prop-initial-capital').textContent || '0'));
                        const appRate = Number(JSON.parse(document.getElementById('app-rate').textContent || '5')) / 100;
                        const capMonthlyRate = Math.pow(1 + appRate, 1 / 12) - 1;
                        const appreciationCum = [];
                        for (let i = 0; i < labels.length; i++) {
                            const months = i;
                            const capValue = initialCapital * Math.pow(1 + capMonthlyRate, months);
                            appreciationCum.push(capValue - initialCapital);
                        }
                        const costArray = (function () {
                            const initialCapitalBM = JSON.parse(document.getElementById('prop-initial-capital').textContent || '0');
                            const monthlyCostBM = initialCapitalBM * (0.06 / 12);
                            const arr = [];
                            for (let i = 0; i < labels.length; i++) {
                                arr.push(monthlyCostBM * i);
                            }
                            return arr;
                        })();
                        const out = [];
                        for (let i = 0; i < labels.length; i++) {
                            out.push((inc[i] || 0) + (appreciationCum[i] || 0) - (costArray[i] || 0));
                        }
                        return out;
                    })();
                    let cross = null;
                    let crossMonths = null;
                    for (let i = 0; i < labels.length; i++) {
                        if ((total[i] || 0) >= (initialCapitalBM || 0)) {
                            cross = labels[i];
                            crossMonths = i;
                            break;
                        }
                    }
                    if (cross) {
                        opts.plugins = opts.plugins || {};
                        opts.plugins.annotation = {
                            annotations: {
                                netCross: {
                                    type: 'line', scaleID: 'x', value: cross, borderColor: 'rgba(25,135,84,0.9)', borderDash: [6, 4], borderWidth: 2,
                                    label: {display: true, content: `Payoff Date: ${cross} (${crossMonths} months)`, position: 'start', backgroundColor: 'rgba(255,255,255,0.85)', color: '#212529', padding: 4}
                                }
                            }
                        };
                    }
                    return opts;
                })()
            });
        })();
    </script>
{% endblock %}


