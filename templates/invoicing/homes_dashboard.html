{% extends "base.html" %}

{% block title %}Horsten Homes Dashboard{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0">Horsten Homes Dashboard</h1>
        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary" href="{% url 'invoice_list' %}">Invoices</a>
            <a class="btn btn-outline-secondary" href="{% url 'expense_list' %}">Expenses</a>
            <a class="btn btn-outline-info" href="{% url 'rental_property_list' %}">Properties</a>
            <a class="btn btn-outline-primary" href="{% url 'rental_pipeline_list' %}">Pipeline</a>
            <a class="btn btn-outline-secondary" href="{% url 'agent_list' %}">Agent</a>


        </div>
    </div>

    <h2 class="mb-3 mt-3 text-center">Revenue</h2>
    <div class="row g-3 mb-3">
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-1">Total (All)</h6>
                    <div class="display-6">{{ totals.total_all }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-1">Paid</h6>
                    <div class="display-6 text-success">{{ totals.total_paid }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-1">Unpaid</h6>
                    <div class="display-6 text-danger">{{ totals.total_unpaid }}</div>
                </div>
            </div>
        </div>
    </div>
    <h2 class="mb-3 mt-3 text-center">Projections</h2>


    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Aggregated Projection (All Properties)</h5>
                <form method="get" class="d-flex align-items-center">
                    <label for="homesRateSelect" class="me-2 mb-0 small">Growth</label>
                    <select id="homesRateSelect" name="rate" class="form-select form-select-sm" onchange="this.form.submit()">
                        <option value="3" {% if growth_rate_percent|floatformat:'2' == '3.00' %}selected{% endif %}>3%</option>
                        <option value="4" {% if growth_rate_percent|floatformat:'2' == '4.00' %}selected{% endif %}>4%</option>
                        <option value="5" {% if growth_rate_percent|floatformat:'2' == '5.00' %}selected{% endif %}>5%</option>
                        <option value="6" {% if growth_rate_percent|floatformat:'2' == '6.00' %}selected{% endif %}>6%</option>
                        <option value="7.5" {% if growth_rate_percent|floatformat:'2' == '7.50' %}selected{% endif %}>7.5%</option>
                        <option value="10" {% if growth_rate_percent|floatformat:'2' == '10.00' %}selected{% endif %}>10%</option>
                        <option value="12.5" {% if growth_rate_percent|floatformat:'2' == '12.50' %}selected{% endif %}>12.5%</option>
                        <option value="15" {% if growth_rate_percent|floatformat:'2' == '15.00' %}selected{% endif %}>15%</option>
                        <option value="17.5" {% if growth_rate_percent|floatformat:'2' == '17.50' %}selected{% endif %}>17.5%</option>
                        <option value="20" {% if growth_rate_percent|floatformat:'2' == '20.00' %}selected{% endif %}>20%</option>
                        <option value="22.5" {% if growth_rate_percent|floatformat:'2' == '22.50' %}selected{% endif %}>22.5%</option>
                        <option value="25" {% if growth_rate_percent|floatformat:'2' == '25.00' %}selected{% endif %}>25%</option>
                        <option value="27.5" {% if growth_rate_percent|floatformat:'2' == '27.50' %}selected{% endif %}>27.5%</option>
                        <option value="30" {% if growth_rate_percent|floatformat:'2' == '30.00' %}selected{% endif %}>30%</option>
                        <option value="32.5" {% if growth_rate_percent|floatformat:'2' == '32.50' %}selected{% endif %}>32.5%</option>
                        <option value="35" {% if growth_rate_percent|floatformat:'2' == '35.00' %}selected{% endif %}>35%</option>
                        <option value="37.5" {% if growth_rate_percent|floatformat:'2' == '37.50' %}selected{% endif %}>37.5%</option>
                        <option value="40" {% if growth_rate_percent|floatformat:'2' == '40.00' %}selected{% endif %}>40%</option>
                        <option value="42.5" {% if growth_rate_percent|floatformat:'2' == '42.50' %}selected{% endif %}>42.5%</option>
                        <option value="45" {% if growth_rate_percent|floatformat:'2' == '45.00' %}selected{% endif %}>45%</option>
                        <option value="47.5" {% if growth_rate_percent|floatformat:'2' == '47.50' %}selected{% endif %}>47.5%</option>
                        <option value="50" {% if growth_rate_percent|floatformat:'2' == '50.00' %}selected{% endif %}>50%</option>
                    </select>
                </form>
            </div>
            <canvas id="aggProjectionChart" height="120"></canvas>
        </div>
    </div>

    {# Provide payoff markers as safe JSON for JS to read #}
    {{ payoff_flow_label_all|json_script:'agg-payoff-flow' }}
    {{ payoff_growing_label_all|json_script:'agg-payoff-grow' }}
    {{ months_to_payoff_flow_all|json_script:'agg-payoff-flow-months' }}
    {{ months_to_payoff_growing_all|json_script:'agg-payoff-grow-months' }}

    <div class="card shadow-sm">
        <!-- <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>Customer</th>
                    <th>Property</th>
                    <th>Issue Date</th>
                    <th>Status</th>
                    <th class="text-end">Total</th>
                </tr>
                </thead>
                <tbody>
                {% for inv in recent %}
                    <tr>
                        <td><a href="{% url 'invoice_detail' inv.id %}">{{ inv.number }}</a></td>
                        <td>{{ inv.customer_name }}</td>
                        <td>{% if inv.rental_property %}<a href="{% url 'rental_property_detail' inv.rental_property.id %}">{{ inv.rental_property.name }}</a>{% else %}<span class="text-muted">â€”</span>{% endif %}</td>
                        <td>{{ inv.issue_date }}</td>
                        <td>{{ inv.get_status_display }}</td>
                        <td class="text-end">{{ inv.total }}</td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="6" class="text-center text-muted">No recent invoices.</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div> -->

    </div>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3"></script>
    <script>
        (function () {
            const labels = {{ agg_labels|default:'[]'|safe }};
            const cumulative = {{ agg_cumulative|default:'[]'|safe }};
            const capitalLine = {{ agg_capital_line|default:'[]'|safe }};
            const initialCapital = {{ agg_initial_capital_line|default:'[]'|safe }};
            const coverage = {{ agg_coverage_line|default:'[]'|safe }};
            const elPayoffFlow = document.getElementById('agg-payoff-flow');
            const elPayoffGrow = document.getElementById('agg-payoff-grow');
            const elPayoffFlowMonths = document.getElementById('agg-payoff-flow-months');
            const elPayoffGrowMonths = document.getElementById('agg-payoff-grow-months');
            const payoffFlow = elPayoffFlow ? JSON.parse(elPayoffFlow.textContent) : null;
            const payoffGrow = elPayoffGrow ? JSON.parse(elPayoffGrow.textContent) : null;
            const payoffFlowMonths = elPayoffFlowMonths ? JSON.parse(elPayoffFlowMonths.textContent) : null;
            const payoffGrowMonths = elPayoffGrowMonths ? JSON.parse(elPayoffGrowMonths.textContent) : null;
            if (!labels.length) return;

            const ctx = document.getElementById('aggProjectionChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {label: 'Cumulative Flow (All)', data: cumulative, borderColor: 'rgba(25,135,84,1)', backgroundColor: 'rgba(25,135,84,0.2)', tension: 0.2, fill: true},
                        {label: 'Capital (All)', data: capitalLine, borderColor: 'rgba(220,53,69,1)', backgroundColor: 'rgba(220,53,69,0.2)', tension: 0, fill: false},
                        {label: 'Initial Capital (All)', data: initialCapital, borderColor: 'rgba(108,117,125,1)', backgroundColor: 'rgba(108,117,125,0.2)', borderDash: [6, 6], tension: 0, fill: false},
                        {label: 'Flow + Appreciation (Coverage, All)', data: coverage, borderColor: 'rgba(255,159,64,1)', backgroundColor: 'rgba(255,159,64,0.2)', tension: 0.2, fill: false},
                    ]
                },
                options: {
                    responsive: true,
                    scales: {y: {beginAtZero: true}},
                    plugins: {
                        annotation: {
                            annotations: (function () {
                                const ann = {};
                                if (payoffFlow) {
                                    const flowContent = payoffFlowMonths ? `Payoff (Flow All): ${payoffFlow} (${payoffFlowMonths} months)` : `Payoff (Flow All): ${payoffFlow}`;
                                    ann.payoffFlowAll = {type: 'line', scaleID: 'x', value: payoffFlow, borderColor: 'rgba(13,110,253,0.8)', borderDash: [4, 4], borderWidth: 2, label: {display: true, content: flowContent, backgroundColor: 'rgba(255,255,255,0.8)', padding: 4, position: 'center'}};
                                }
                                if (payoffGrow) {
                                    const growContent = payoffGrowMonths ? `Payoff (Flow+App All): ${payoffGrow} (${payoffGrowMonths} months)` : `Payoff (Flow+App All): ${payoffGrow}`;
                                    ann.payoffGrowAll = {type: 'line', scaleID: 'x', value: payoffGrow, borderColor: 'rgba(33,37,41,0.7)', borderDash: [6, 4], borderWidth: 2, label: {display: true, content: growContent, backgroundColor: 'rgba(255,255,255,0.8)', padding: 4, position: 'start'}};
                                }
                                return ann;
                            })()
                        }
                    }
                }
            });
        })();
    </script>
{% endblock %}


